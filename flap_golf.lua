-- title:  game title
-- author: game developer
-- desc:   short description
-- script: lua

-- Sprites
BALL=288
WING=289
TRAIL_0=273
TRAIL_1=274
TRAIL_2=275

-- Consts
H_FLAP=0.1
V_FLAP=1
GRAV=0.02
DAMP=0.5
FRIC=0.5
FLAP_T=5
TRAIL_T=10
TRAIL_V0=50
TRAIL_V1=30
TRAIL_V2=20

t=0

ball={
	x=120,
	y=68,
	dx=0,
	dy=0,
	flp=0,
	d=0,
	fd=0
}

function TableRemove(t,rFunc)
 local j,n=1,#t
 for i=1,n do
  if rFunc(t[i]) then
   if i~=j then t[j]=t[i];t[i]=nil; end
   j=j+1
  else t[i]=nil end
 end
 return t
end

trail={}
function addTrail(x,y)
 table.insert(trail,{x=x,y=y,f=TRAIL_V0})
end
function drawTrail()
 for i,t in ipairs(trail) do
 	spr(t.f<TRAIL_V1 and TRAIL_1 or TRAIL_0,t.x-1,t.y-1,0)
  t.f=t.f-1
 end
 TableRemove(trail,function(v)return v.f>0 end)
end

function load(l)
 local x,y=(l-1)%8,(l-1)//8
 for iy=y,y+30 do
  for ix=x,x+17 do
  	if fget(mget(ix,iy),0) then
    ball.x,ball.y=ix*8+4,iy*8+4
   end
  end
 end
end

load(1)

function TIC()

	if btnp(5) then
	 if ball.dx<0 then
			ball.dx=ball.dx+H_FLAP*2
		else
			ball.dx=ball.dx+H_FLAP
		end
		ball.dy=ball.dy-V_FLAP
		ball.d=0
		ball.fd=FLAP_T
		ball.flp=1
	elseif btnp(4) then
	 if ball.dx>0 then
			ball.dx=ball.dx-H_FLAP*2
		else
			ball.dx=ball.dx-H_FLAP
		end
		ball.dy=ball.dy-V_FLAP
		ball.d=1
		ball.fd=FLAP_T
		ball.flp=1
	end
	
	ball.dy=ball.dy+GRAV
	if fget(mget(ball.x//8,(ball.y+ball.dy)//8),2) then
		ball.dy=ball.dy*-DAMP
		if ball.dy>=-0.2 then
			ball.dy=0
			ball.g=true
		end
	else
	 ball.g=false
	end

	if fget(mget((ball.x+ball.dx)//8,ball.y//8),2) then
	 ball.dx=ball.dx*-DAMP
		ball.d=ball.d==0 and 1 or 0
	end
	
	if ball.g==true then
	 ball.dx=ball.dx*FRIC
	end
 
 ball.x=ball.x+ball.dx
	ball.y=ball.y+ball.dy
	
	if ball.x<0 then ball.x=240 end
	if ball.x>240 then ball.x=0 end
	if ball.y<0 then ball.y=138 end
	if ball.y>138 then ball.y=0 end

	cls(0)
 map(0,0,30,17,0,0)
	drawTrail()
	--spr(BALL,ball.x-4,ball.y-8,0)
	spr(BALL,ball.x-2,ball.y-2,0)
	local s=ball.dy>0 and ball.flp or ball.flp==1 and 0 or 1
	--spr(WING+s,ball.x-(ball.d==0 and 7 or 1),ball.y-10,0,1,ball.d)
	spr(WING+s,ball.x-(ball.d==0 and 5 or 3),ball.y-4,0,1,ball.d)
	if ball.fd>0 then
		ball.fd=ball.fd-1
		if ball.fd<=0 then
		 ball.flp,ball.fd=0,0
		end
	end
	
	t=t+1
	if t%TRAIL_T==0 and math.abs(ball.dy)>0.2 then
	 addTrail(ball.x-1,ball.y-1)
	end
end

-- <TILES>
-- 001:5555555555555555666666666666666666666666666666666666666666666666
-- 002:000000000000d0000003d0000032d0000000d0000000d0000000d000000ed000
-- 003:7777777700000000000000000000000000000000000000000000000000000000
-- 016:0222222002211110022000000222222001111220000002200222222001111110
-- 017:6666666666666666666666666666666666666666666666666666666666666666
-- 018:55eccf55555ff555666666666666666666666666666666666666666666666666
-- 019:4343434334343434777777776666666666666666666666666666666666666666
-- 033:6666666666677766667fff5667ffff5667ffff5667fff5666655566666666666
-- 034:666666666666666666677666667ff766667fff566667ff566666556666666666
-- </TILES>

-- <SPRITES>
-- 000:00cccd000cccccd0ccccccdecccccdcedcdcdcdeddcdcdde0dedede000eeee00
-- 001:0bbbb000dadadb00adadadb09a9adadb09d9adad000d99d00000000000000000
-- 002:00000000000000000bbbbbb0bdadadaddadadadaadada9a0dad9900009900000
-- 016:0440000043320000433200000220000000000000000000000000000000000000
-- 017:0400000043200000020000000000000000000000000000000000000000000000
-- 018:0000000004000000000000000000000000000000000000000000000000000000
-- 032:0cc00000ccdd0000cdce00000de0000000000000000000000000000000000000
-- 033:000000000bb000000aab0000009a000000000000000000000000000000000000
-- 034:000000000000000000bb00000baa00000a900000000000000000000000000000
-- </SPRITES>

-- <MAP>
-- 000:111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:113030303030303030303030303030303030303030303030303030303011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:110000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:110000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:110000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:110001000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:110000000000000000000000000000000000000000000020000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:111010101010100000000000000000000000000000101021101000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:111111111122110000000000001010100000000000111211111100000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:111112111111110000000000001122110000000000111111111100000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:111111111111110000000000001111110000000000111111111100000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:111111111111111010101010101111110000000000111111221100000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:111111111111111111111111111211111010101010111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:111111111122111111111111111111111111111111111111111112111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:111111111111111111111111111111111111221111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <FLAGS>
-- 000:00400040000000000000000000000000104060000000000000000000000000000040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

